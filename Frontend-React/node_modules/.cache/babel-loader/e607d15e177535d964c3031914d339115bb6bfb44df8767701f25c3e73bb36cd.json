{"ast":null,"code":"import * as signalR from '@microsoft/signalr';\nclass SignalRService {\n  constructor() {\n    this.connection = null;\n    this.reconnectAttempts = 0;\n    this.maxReconnectAttempts = 5;\n  }\n  async startConnection() {\n    try {\n      this.connection = new signalR.HubConnectionBuilder().withUrl(`${process.env.REACT_APP_API_URL}/notificationHub`, {\n        accessTokenFactory: () => localStorage.getItem('token') || ''\n      }).withAutomaticReconnect({\n        nextRetryDelayInMilliseconds: retryContext => {\n          if (retryContext.previousRetryCount >= this.maxReconnectAttempts) {\n            return null; // Stop trying to reconnect\n          }\n          return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 30000);\n        }\n      }).configureLogging(signalR.LogLevel.Information).build();\n\n      // Add connection lifecycle handlers\n      this.setupConnectionHandlers();\n      await this.connection.start();\n      console.log('SignalR Connected');\n    } catch (err) {\n      console.error('Error starting SignalR connection:', err);\n      throw err;\n    }\n  }\n  setupConnectionHandlers() {\n    if (!this.connection) return;\n    this.connection.onreconnecting(error => {\n      console.log('Attempting to reconnect:', error);\n      this.reconnectAttempts++;\n    });\n    this.connection.onreconnected(connectionId => {\n      console.log('Reconnected with ID:', connectionId);\n      this.reconnectAttempts = 0;\n    });\n    this.connection.onclose(error => {\n      console.log('Connection closed:', error);\n      if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n        window.location.href = '/login';\n      }\n    });\n  }\n  isConnected() {\n    var _this$connection;\n    return ((_this$connection = this.connection) === null || _this$connection === void 0 ? void 0 : _this$connection.state) === signalR.HubConnectionState.Connected;\n  }\n  onNotification(callback) {\n    var _this$connection2;\n    (_this$connection2 = this.connection) === null || _this$connection2 === void 0 ? void 0 : _this$connection2.on('ReceiveNotification', notification => {\n      console.log('Received notification:', notification);\n      callback(notification);\n    });\n  }\n  offNotification() {\n    var _this$connection3;\n    (_this$connection3 = this.connection) === null || _this$connection3 === void 0 ? void 0 : _this$connection3.off('ReceiveNotification');\n  }\n  addNoteUpdateListener(callback) {\n    var _this$connection4;\n    (_this$connection4 = this.connection) === null || _this$connection4 === void 0 ? void 0 : _this$connection4.on('NoteUpdated', callback);\n  }\n  addNoteDeleteListener(callback) {\n    var _this$connection5;\n    (_this$connection5 = this.connection) === null || _this$connection5 === void 0 ? void 0 : _this$connection5.on('NoteDeleted', callback);\n  }\n  async stopConnection() {\n    try {\n      var _this$connection6;\n      await ((_this$connection6 = this.connection) === null || _this$connection6 === void 0 ? void 0 : _this$connection6.stop());\n      console.log('SignalR Disconnected');\n    } catch (err) {\n      console.error('Error stopping SignalR connection:', err);\n      throw err;\n    }\n  }\n  async reconnect() {\n    if (!this.isConnected()) {\n      await this.startConnection();\n    }\n  }\n}\nexport const signalRService = new SignalRService();","map":{"version":3,"names":["signalR","SignalRService","constructor","connection","reconnectAttempts","maxReconnectAttempts","startConnection","HubConnectionBuilder","withUrl","process","env","REACT_APP_API_URL","accessTokenFactory","localStorage","getItem","withAutomaticReconnect","nextRetryDelayInMilliseconds","retryContext","previousRetryCount","Math","min","pow","configureLogging","LogLevel","Information","build","setupConnectionHandlers","start","console","log","err","error","onreconnecting","onreconnected","connectionId","onclose","window","location","href","isConnected","_this$connection","state","HubConnectionState","Connected","onNotification","callback","_this$connection2","on","notification","offNotification","_this$connection3","off","addNoteUpdateListener","_this$connection4","addNoteDeleteListener","_this$connection5","stopConnection","_this$connection6","stop","reconnect","signalRService"],"sources":["D:/_master/v5/notepad-plus/src/services/signalRService.ts"],"sourcesContent":["import * as signalR from '@microsoft/signalr';\r\nimport { api } from './api';\r\nimport { Notification } from '../types/Notification';\r\nimport { NotificationType } from '../types/NotificationType';\r\n\r\nclass SignalRService {\r\n    private connection: signalR.HubConnection | null = null;\r\n    private reconnectAttempts = 0;\r\n    private readonly maxReconnectAttempts = 5;\r\n\r\n    public async startConnection(): Promise<void> {\r\n        try {\r\n            this.connection = new signalR.HubConnectionBuilder()\r\n                .withUrl(`${process.env.REACT_APP_API_URL}/notificationHub`, {\r\n                    accessTokenFactory: () => localStorage.getItem('token') || ''\r\n                })\r\n                .withAutomaticReconnect({\r\n                    nextRetryDelayInMilliseconds: retryContext => {\r\n                        if (retryContext.previousRetryCount >= this.maxReconnectAttempts) {\r\n                            return null; // Stop trying to reconnect\r\n                        }\r\n                        return Math.min(1000 * Math.pow(2, retryContext.previousRetryCount), 30000);\r\n                    }\r\n                })\r\n                .configureLogging(signalR.LogLevel.Information)\r\n                .build();\r\n\r\n            // Add connection lifecycle handlers\r\n            this.setupConnectionHandlers();\r\n            await this.connection.start();\r\n            console.log('SignalR Connected');\r\n        } catch (err) {\r\n            console.error('Error starting SignalR connection:', err);\r\n            throw err;\r\n        }\r\n    }\r\n\r\n    private setupConnectionHandlers(): void {\r\n        if (!this.connection) return;\r\n\r\n        this.connection.onreconnecting(error => {\r\n            console.log('Attempting to reconnect:', error);\r\n            this.reconnectAttempts++;\r\n        });\r\n\r\n        this.connection.onreconnected(connectionId => {\r\n            console.log('Reconnected with ID:', connectionId);\r\n            this.reconnectAttempts = 0;\r\n        });\r\n\r\n        this.connection.onclose(error => {\r\n            console.log('Connection closed:', error);\r\n            if (this.reconnectAttempts >= this.maxReconnectAttempts) {\r\n                window.location.href = '/login';\r\n            }\r\n        });\r\n    }\r\n\r\n    public isConnected(): boolean {\r\n        return this.connection?.state === signalR.HubConnectionState.Connected;\r\n    }\r\n\r\n    public onNotification(callback: (notification: Notification) => void): void {\r\n        this.connection?.on('ReceiveNotification', (notification: Notification) => {\r\n            console.log('Received notification:', notification);\r\n            callback(notification);\r\n        });\r\n    }\r\n\r\n    public offNotification(): void {\r\n        this.connection?.off('ReceiveNotification');\r\n    }\r\n\r\n    public addNoteUpdateListener(callback: (note: any) => void): void {\r\n        this.connection?.on('NoteUpdated', callback);\r\n    }\r\n\r\n    public addNoteDeleteListener(callback: (noteId: number) => void): void {\r\n        this.connection?.on('NoteDeleted', callback);\r\n    }\r\n\r\n    public async stopConnection(): Promise<void> {\r\n        try {\r\n            await this.connection?.stop();\r\n            console.log('SignalR Disconnected');\r\n        } catch (err) {\r\n            console.error('Error stopping SignalR connection:', err);\r\n            throw err;\r\n        }\r\n    }\r\n\r\n    public async reconnect(): Promise<void> {\r\n        if (!this.isConnected()) {\r\n            await this.startConnection();\r\n        }\r\n    }\r\n}\r\n\r\nexport const signalRService = new SignalRService(); "],"mappings":"AAAA,OAAO,KAAKA,OAAO,MAAM,oBAAoB;AAK7C,MAAMC,cAAc,CAAC;EAAAC,YAAA;IAAA,KACTC,UAAU,GAAiC,IAAI;IAAA,KAC/CC,iBAAiB,GAAG,CAAC;IAAA,KACZC,oBAAoB,GAAG,CAAC;EAAA;EAEzC,MAAaC,eAAeA,CAAA,EAAkB;IAC1C,IAAI;MACA,IAAI,CAACH,UAAU,GAAG,IAAIH,OAAO,CAACO,oBAAoB,CAAC,CAAC,CAC/CC,OAAO,CAAC,GAAGC,OAAO,CAACC,GAAG,CAACC,iBAAiB,kBAAkB,EAAE;QACzDC,kBAAkB,EAAEA,CAAA,KAAMC,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC,IAAI;MAC/D,CAAC,CAAC,CACDC,sBAAsB,CAAC;QACpBC,4BAA4B,EAAEC,YAAY,IAAI;UAC1C,IAAIA,YAAY,CAACC,kBAAkB,IAAI,IAAI,CAACb,oBAAoB,EAAE;YAC9D,OAAO,IAAI,CAAC,CAAC;UACjB;UACA,OAAOc,IAAI,CAACC,GAAG,CAAC,IAAI,GAAGD,IAAI,CAACE,GAAG,CAAC,CAAC,EAAEJ,YAAY,CAACC,kBAAkB,CAAC,EAAE,KAAK,CAAC;QAC/E;MACJ,CAAC,CAAC,CACDI,gBAAgB,CAACtB,OAAO,CAACuB,QAAQ,CAACC,WAAW,CAAC,CAC9CC,KAAK,CAAC,CAAC;;MAEZ;MACA,IAAI,CAACC,uBAAuB,CAAC,CAAC;MAC9B,MAAM,IAAI,CAACvB,UAAU,CAACwB,KAAK,CAAC,CAAC;MAC7BC,OAAO,CAACC,GAAG,CAAC,mBAAmB,CAAC;IACpC,CAAC,CAAC,OAAOC,GAAG,EAAE;MACVF,OAAO,CAACG,KAAK,CAAC,oCAAoC,EAAED,GAAG,CAAC;MACxD,MAAMA,GAAG;IACb;EACJ;EAEQJ,uBAAuBA,CAAA,EAAS;IACpC,IAAI,CAAC,IAAI,CAACvB,UAAU,EAAE;IAEtB,IAAI,CAACA,UAAU,CAAC6B,cAAc,CAACD,KAAK,IAAI;MACpCH,OAAO,CAACC,GAAG,CAAC,0BAA0B,EAAEE,KAAK,CAAC;MAC9C,IAAI,CAAC3B,iBAAiB,EAAE;IAC5B,CAAC,CAAC;IAEF,IAAI,CAACD,UAAU,CAAC8B,aAAa,CAACC,YAAY,IAAI;MAC1CN,OAAO,CAACC,GAAG,CAAC,sBAAsB,EAAEK,YAAY,CAAC;MACjD,IAAI,CAAC9B,iBAAiB,GAAG,CAAC;IAC9B,CAAC,CAAC;IAEF,IAAI,CAACD,UAAU,CAACgC,OAAO,CAACJ,KAAK,IAAI;MAC7BH,OAAO,CAACC,GAAG,CAAC,oBAAoB,EAAEE,KAAK,CAAC;MACxC,IAAI,IAAI,CAAC3B,iBAAiB,IAAI,IAAI,CAACC,oBAAoB,EAAE;QACrD+B,MAAM,CAACC,QAAQ,CAACC,IAAI,GAAG,QAAQ;MACnC;IACJ,CAAC,CAAC;EACN;EAEOC,WAAWA,CAAA,EAAY;IAAA,IAAAC,gBAAA;IAC1B,OAAO,EAAAA,gBAAA,OAAI,CAACrC,UAAU,cAAAqC,gBAAA,uBAAfA,gBAAA,CAAiBC,KAAK,MAAKzC,OAAO,CAAC0C,kBAAkB,CAACC,SAAS;EAC1E;EAEOC,cAAcA,CAACC,QAA8C,EAAQ;IAAA,IAAAC,iBAAA;IACxE,CAAAA,iBAAA,OAAI,CAAC3C,UAAU,cAAA2C,iBAAA,uBAAfA,iBAAA,CAAiBC,EAAE,CAAC,qBAAqB,EAAGC,YAA0B,IAAK;MACvEpB,OAAO,CAACC,GAAG,CAAC,wBAAwB,EAAEmB,YAAY,CAAC;MACnDH,QAAQ,CAACG,YAAY,CAAC;IAC1B,CAAC,CAAC;EACN;EAEOC,eAAeA,CAAA,EAAS;IAAA,IAAAC,iBAAA;IAC3B,CAAAA,iBAAA,OAAI,CAAC/C,UAAU,cAAA+C,iBAAA,uBAAfA,iBAAA,CAAiBC,GAAG,CAAC,qBAAqB,CAAC;EAC/C;EAEOC,qBAAqBA,CAACP,QAA6B,EAAQ;IAAA,IAAAQ,iBAAA;IAC9D,CAAAA,iBAAA,OAAI,CAAClD,UAAU,cAAAkD,iBAAA,uBAAfA,iBAAA,CAAiBN,EAAE,CAAC,aAAa,EAAEF,QAAQ,CAAC;EAChD;EAEOS,qBAAqBA,CAACT,QAAkC,EAAQ;IAAA,IAAAU,iBAAA;IACnE,CAAAA,iBAAA,OAAI,CAACpD,UAAU,cAAAoD,iBAAA,uBAAfA,iBAAA,CAAiBR,EAAE,CAAC,aAAa,EAAEF,QAAQ,CAAC;EAChD;EAEA,MAAaW,cAAcA,CAAA,EAAkB;IACzC,IAAI;MAAA,IAAAC,iBAAA;MACA,QAAAA,iBAAA,GAAM,IAAI,CAACtD,UAAU,cAAAsD,iBAAA,uBAAfA,iBAAA,CAAiBC,IAAI,CAAC,CAAC;MAC7B9B,OAAO,CAACC,GAAG,CAAC,sBAAsB,CAAC;IACvC,CAAC,CAAC,OAAOC,GAAG,EAAE;MACVF,OAAO,CAACG,KAAK,CAAC,oCAAoC,EAAED,GAAG,CAAC;MACxD,MAAMA,GAAG;IACb;EACJ;EAEA,MAAa6B,SAASA,CAAA,EAAkB;IACpC,IAAI,CAAC,IAAI,CAACpB,WAAW,CAAC,CAAC,EAAE;MACrB,MAAM,IAAI,CAACjC,eAAe,CAAC,CAAC;IAChC;EACJ;AACJ;AAEA,OAAO,MAAMsD,cAAc,GAAG,IAAI3D,cAAc,CAAC,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}